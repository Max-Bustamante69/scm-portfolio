---
import { getCollection, type CollectionEntry } from "astro:content";
import SkillCard from "./SkillCard.astro";

type Experience = CollectionEntry<"skills">;
const skillsCollection: Experience[] = await getCollection("skills");
const skills = skillsCollection.map((skill) => skill.data);

// Always start with Frontend and Backend
const baseTabs = ["Frontend", "Backend"];
const categorySet = new Set<string>();
skills.forEach(({ categories }) =>
  categories.forEach((cat) => {
    if (!baseTabs.includes(cat)) categorySet.add(cat);
  })
);
const tabs = [...baseTabs, ...Array.from(categorySet)];
---

<div class="flex flex-col items-center">
  <div
    role="tablist"
    aria-label="Skill categories"
    class="flex bg-card-background/60 rounded-full px-4 py-2 space-x-6 text-xl shadow-lg mb-10"
    id="skill-tabs"
  >
    {
      tabs.map((tab, i) => (
        <button
          role="tab"
          type="button"
          aria-selected="false"
          tabindex="-1"
          class="px-4 py-2 rounded-full transition duration-200 text-subtext hover:text-white"
          data-category={tab}
          data-tab-index={i}
        >
          {tab}
        </button>
      ))
    }
  </div>

  <div
    class="grid grid-cols-2 lg:grid-cols-3 gap-6 px-2 w-full content-center justify-items-center md:gap-8"
    id="skill-cards"
  >
    {
      skills.map(({ skillName, description, proficiency, categories }) => (
        <SkillCard
          name={skillName}
          description={description}
          proficiency={proficiency}
          categories={categories}
          data-categories={categories.join(",")}
          class="skill-card hidden"
        />
      ))
    }
  </div>
</div>

<script type="module" defer>
  const tabs = Array.from(
    document.querySelectorAll('#skill-tabs [role="tab"]')
  );
  const cards = Array.from(document.querySelectorAll(".skill-card"));

  let currentTabIdx = 0;

  function filterCards(category) {
    cards.forEach((card) => {
      const cardCategories = card.dataset.categories.split(",");
      if (cardCategories.includes(category)) {
        card.classList.remove("hidden");
        card.classList.add("block");
      } else {
        card.classList.remove("block");
        card.classList.add("hidden");
      }
    });
  }

  function selectTab(newIdx) {
    if (newIdx === currentTabIdx) return;

    // Update previous tab
    const prevTab = tabs[currentTabIdx];
    prevTab.setAttribute("aria-selected", "false");
    prevTab.tabIndex = -1;
    prevTab.classList.remove("text-accent");
    prevTab.classList.add("text-subtext");

    // Update new tab
    const newTab = tabs[newIdx];
    newTab.setAttribute("aria-selected", "true");
    newTab.tabIndex = 0;
    newTab.classList.add("text-accent");
    newTab.classList.remove("text-subtext");

    // Update cards
    filterCards(newTab.dataset.category);

    currentTabIdx = newIdx;
  }

  // Set the first tab as active on load
  if (tabs.length) {
    tabs[0].setAttribute("aria-selected", "true");
    tabs[0].tabIndex = 0;
    tabs[0].classList.add("text-accent");
    tabs[0].classList.remove("text-subtext");
    filterCards(tabs[0].dataset.category);
  }

  tabs.forEach((tab, idx) => {
    tab.addEventListener("click", (e) => {
      e.preventDefault();
      selectTab(idx);
    });
    tab.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight") {
        e.preventDefault();
        selectTab((idx + 1) % tabs.length);
      } else if (e.key === "ArrowLeft") {
        e.preventDefault();
        selectTab((idx - 1 + tabs.length) % tabs.length);
      } else if (e.key === "Home") {
        e.preventDefault();
        selectTab(0);
      } else if (e.key === "End") {
        e.preventDefault();
        selectTab(tabs.length - 1);
      }
    });
  });
</script>
